pipeline {
  agent any

  environment {
    VIRTUAL_ENV    = 'venv'
    PIP_CACHE_DIR  = "${env.WORKSPACE}/.pip-cache"
  }

  options {
    timestamps()        // keep timestamps (core)
    // removed ansiColor to avoid plugin error
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        sh 'python --version || true'
        sh 'pip --version || true'
      }
    }

    stage('Setup') {
      steps {
        script {
          if (!fileExists("${env.WORKSPACE}/${VIRTUAL_ENV}")) {
            sh "python -m venv ${VIRTUAL_ENV}"
          }
          sh """
            python -m pip install --upgrade pip
            ${VIRTUAL_ENV}/bin/pip install --upgrade pip wheel
            mkdir -p ${PIP_CACHE_DIR}
            PIP_CACHE_DIR=${PIP_CACHE_DIR} ${VIRTUAL_ENV}/bin/pip install -r requirements.txt
          """
        }
      }
    }

    stage('Lint') {
      steps {
        sh "${VIRTUAL_ENV}/bin/flake8 app.py"
      }
    }

    stage('Test') {
      steps {
        // produce JUnit XML so Jenkins can show tests
        sh "${VIRTUAL_ENV}/bin/pytest --junitxml=pytest-results.xml -q"
      }
      post {
        always {
          junit allowEmptyResults: true, testResults: 'pytest-results.xml'
        }
      }
    }

    stage('Coverage') {
      steps {
        sh """
          ${VIRTUAL_ENV}/bin/coverage run -m pytest --junitxml=pytest-results.xml
          ${VIRTUAL_ENV}/bin/coverage report -m
          ${VIRTUAL_ENV}/bin/coverage xml -o coverage.xml
        """
      }
      post {
        always {
          // avoid Cobertura plugin dependency; just archive XML
          archiveArtifacts artifacts: 'coverage.xml', fingerprint: true
        }
      }
    }

    stage('Security Scan') {
      steps {
        // don't fail the whole build on Bandit findings in this template
        sh "${VIRTUAL_ENV}/bin/bandit -r . -f txt -o bandit.txt || true"
      }
      post {
        always {
          archiveArtifacts artifacts: 'bandit.txt', fingerprint: true
        }
      }
    }

    stage('Deploy') {
      when { branch 'main' }
      steps {
        sh """
          mkdir -p dist
          printf '#!/usr/bin/env bash\nsource ${VIRTUAL_ENV}/bin/activate && python app.py\n' > dist/run.sh
          chmod +x dist/run.sh
          tar -czf dist/app_bundle.tgz app.py requirements.txt || true
        """
        archiveArtifacts artifacts: 'dist/**', fingerprint: true
        echo "Deploying application... (placeholder)"
      }
    }
  }

  post {
    always {
      cleanWs()
    }
  }
}
