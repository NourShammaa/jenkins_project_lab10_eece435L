pipeline {
  agent any

  environment {
    VENV = 'venv'
  }

  options { timestamps() }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
        // Show Python on PATH (optional)
        bat 'where py || where python || ver'
      }
    }

    stage('Setup') {
      steps {
        script {
          // Create venv if missing (try py, fallback to python)
          bat """
          if not exist %VENV%\\Scripts\\python.exe (
            py -3 -m venv %VENV% || python -m venv %VENV%
          )
          """
          // Upgrade pip & install deps
          bat """
          %VENV%\\Scripts\\python -m pip install --upgrade pip wheel
          %VENV%\\Scripts\\pip install -r requirements.txt
          """
        }
      }
    }

    stage('Lint') {
      steps {
        bat "%VENV%\\Scripts\\flake8 app.py"
      }
    }
    stage('Test') {
      steps {
    // Add workspace to Python path so "from app import greet" works
        bat "set PYTHONPATH=%CD% && %VENV%\\Scripts\\pytest --junitxml=pytest-results.xml -q"
      }
      post {
        always {
      junit allowEmptyResults: true, testResults: 'pytest-results.xml'
    }
  }
}
    stage('Coverage') {
      steps {
        bat """
    set PYTHONPATH=%CD% && %VENV%\\Scripts\\coverage run -m pytest --junitxml=pytest-results.xml
    %VENV%\\Scripts\\coverage report -m
    %VENV%\\Scripts\\coverage xml -o coverage.xml
    """
      }
      post {
        always {
          archiveArtifacts artifacts: 'coverage.xml', fingerprint: true
    }
  }
}
   
    stage('Security Scan') {
      steps {
        // Don't fail build if Bandit finds issues in this template
        bat "%VENV%\\Scripts\\bandit -r . -f txt -o bandit.txt || exit /b 0"
      }
      post {
        always {
          archiveArtifacts artifacts: 'bandit.txt', fingerprint: true
        }
      }
    }

    stage('Deploy') {
      when { branch 'main' }
      steps {
        bat """
        if not exist dist mkdir dist
        echo @echo off> dist\\run.bat
        echo call %VENV%\\Scripts\\python app.py>> dist\\run.bat
        tar -czf dist\\app_bundle.tgz app.py requirements.txt 2>nul || powershell -NoLogo -NoProfile -Command "Compress-Archive -Path app.py, requirements.txt -DestinationPath dist\\app_bundle.zip -Force"
        """
        archiveArtifacts artifacts: 'dist/**', fingerprint: true
        echo "Deploying application... (placeholder)"
      }
    }

  }

  post {
    always {
      cleanWs()
    }
  }
}
